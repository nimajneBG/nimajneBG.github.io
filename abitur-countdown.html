<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Benjamin Grau" />
    <meta name="description" content="Ein Timer für die Abiturprüfungen 2024 in Hessen" />
    <meta name="color-scheme" content="dark light" />
    <title>Abitur Countdown</title>
    <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>
    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
            font: inherit;
            color: inherit;
            box-sizing: border-box;
            align-items: center;
        }

        :root {
            --c-background: #18191a;
            --c-text: #e4e6eb;
            --c-highlight: #fff;
            --c-muted: #4d4f50;
        }

        @media (prefers-color-scheme: light) {
            :root {
                --c-background: #e4e6eb;
                --c-text: #242526;
                --c-highlight: #000;
            }
        }

        body {
            display: flex;
            justify-content: center;
            height: 100vh;
            background-color: var(--c-background);
            color: var(--c-text);
            font-family: "Fira Sans", system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        #main-container {
            padding: 1rem;
            text-align: center;
        }

        .title {
            font-size: 20px;
        }

        select {
            border: none;
            cursor: pointer;
            background: inherit;
        }

        #countdown {
            font-family: monospace;
            font-size: 45px;
            font-weight: 600;
            color: var(--c-highlight);
        }

        .credits {
            position: fixed;
            bottom: 0;
            padding: 1rem 3rem;
            text-align: center;
            color: var(--c-muted);
        }
        
        .noscript { 
            position: fixed;
            top: 0;
            padding: 5rem;
            font-size: 3rem;
            display: block;
            text-align: center;
        }

        @media (width > 600px) {
            #countdown { font-size: 84px; }
        }

        @media (width > 800px) {
            #countdown { font-size: 110px; }
        }
        
        @media (width > 1350px) {
            #countdown { font-size: 190px; }
        }
    </style>
</head>
<body>
    <noscript>
        <span class="noscript">Dieser Timer braucht JavaScript zum Funktionieren</span>
    </noscript>
    <div id="main-container">
        <p class="title">Zeit bis zur nächsten schriftlichen Abiturprüfung:</p>
        <p id="countdown">
            <span id="sign"></span><span id="days">00</span>:<span id="hours">00</span>:<span id="minutes">00</span>:<span id="seconds">00</span>
        </p>
        <select id="dehdeu">
            <option value="-1">Automatisch</option>
            <option value="0">LK PoWi</option>
            <option value="0">LK Erdkunde</option>
            <option value="0">LK WiWi</option>
            <option value="0">LK Musik</option>
            <option value="0">LK Geschichte</option>
            <option value="1">LK Altgrichisch</option>
            <option value="2">LK Latein</option>
            <option value="2">LK Spanisch</option>
            <option value="3">LK/GK Französisch</option>
            <option value="4">LK/GK Deutsch</option>
            <option value="5">LK/GK Physik</option>
            <option value="6">GK Spanisch</option>
            <option value="6">GK Kunst</option>
            <option value="6">GK Musik</option>
            <option value="6">GK Geschichte</option>
            <option value="6">GK PoWi</option>
            <option value="6">GK WiWi</option>
            <option value="6">GK Erdkunde</option>
            <option value="6">GK Religion</option>
            <option value="6">GK Ethik</option>
            <option value="7">LK/GK Englisch</option>
            <option value="8">LK/GK Biologie</option>
            <option value="9">LK/GK Mathematik</option>
            <option value="10">LK/GK Chemie</option>
        </select>
        am <span id="termin"></span> Uhr
    </div>
    <div class="credits">Benjamin Grau 2024 // Keine Gewähr für die Richtigkeit der Daten // <a href="https://github.com/nimajneBG">GitHub</a></div>
</body>

<script>
    const pruefungen = [
        new Date("2024-04-17 09:00"),
        new Date("2024-04-18 09:00"),
        new Date("2024-04-19 09:00"),
        new Date("2024-04-22 09:00"),
        new Date("2024-04-25 09:00"),
        new Date("2024-04-26 09:00"),
        new Date("2024-05-02 09:00"),
        new Date("2024-05-03 09:00"),
        new Date("2024-05-06 09:00"),
        new Date("2024-05-07 09:00"),
        new Date("2024-05-08 09:00"),
    ]

    var index = -1

    document.body.onload = () => {
        const days = document.getElementById('days')
        const hours = document.getElementById('hours')
        const minutes = document.getElementById('minutes')
        const seconds = document.getElementById('seconds')

        const termin = document.getElementById('termin')
        const select = document.getElementById('dehdeu')
        const sign = document.getElementById('sign')

        function refresh() {
            let d = pruefungen[index] - new Date()
            if (d < 0) { 
                d = -d
                sign.innerHTML = '-'
            } else { sign.innerHTML = '' }
            days.innerHTML = Math.floor(d / (1000 * 60 * 60 * 24)).toString().padStart(2, '0')
            hours.innerHTML = Math.floor((d / (1000 * 60 * 60)) % 24).toString().padStart(2, '0')
            minutes.innerHTML = Math.floor((d / 1000 / 60) % 60).toString().padStart(2, '0')
            seconds.innerHTML = Math.floor((d / 1000) % 60).toString().padStart(2, '0')
        }

        function updateDateText() {
            termin.innerHTML = pruefungen[index].toLocaleString()
        }

        function findNextTest() {
            const now = new Date()
            for (let i = 0; i < pruefungen.length; i++) {
                if ((pruefungen[i] - now) > 0) {
                    index = i
                    break
                }
            }
            select.value = index
            updateDateText()
        }

        select.onchange = () => {
            console.log('Fach manuell geändert')
            if (select.value == -1) {   // automatische Auswahl des nächsten Termins
                localStorage.clear()
                findNextTest()
            } else {                    // termin explizit gewählt
                index = select.value
                writeI()
            }
            updateDateText()
            refresh()
        }

        function readI() {
            const urlParams = new URLSearchParams(window.location.search)
            if (urlParams.has('fach')) {    // Reading from URL Parmeters
                let i = Number(urlParams.get('fach'))
                if (i >= 0 && i <= pruefungen.length) { 
                    index = i 
                    console.log(`Prüfung i=${index} aus URL Parametern ausgelesen`)
                }
            } 
            if (index === -1) {             // Reading from Local Storage
                const i = localStorage.getItem('index')
                if (!i) { 
                    console.debug('Keine ausgewählte Prüfung aus localStorage ausgelesen')
                    return findNextTest() 
                }
                index = Number(i)
                console.log(`Prüfung i=${index} aus Local Storage ausgelesen`)
                if ((pruefungen[index] - new Date()) < 0) {
                    localStorage.clear()
                    console.log('Prüfung im Local Storage vorbei. Gelöscht und automatisch Nächste gesucht')
                    return findNextTest()
                }
            }
            select.value = index
            updateDateText()
        }

        function writeI() {
            localStorage.setItem('index', index)
        }

        readI()
        refresh()
        setInterval(refresh, 1000)
        
        if ((pruefungen[pruefungen.length - 1] - new Date()) < 0) {
            const jsConfetti = new JSConfetti()

            jsConfetti.addConfetti()
        }
    }
</script>
</html>
